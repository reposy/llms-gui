# HTML Parser 노드

### 1. 개요

`HTML Parser` 노드는 `Web Crawler` 노드 등으로부터 전달받은 HTML 문자열을 입력으로 받아, 사용자가 정의한 규칙에 따라 원하는 데이터를 추출하고 구조화된 형태(JSON 객체)로 출력하는 **프론트엔드 기반 노드**입니다.

-   **입력:** 다른 노드로부터 HTML 문자열 또는 HTML 문자열을 포함하는 객체 (`.html` 또는 `.text` 필드)를 받습니다.
-   **처리:** 사용자가 정의한 추출 규칙(`ExtractionRule[]`)에 따라 **브라우저의 내장 `DOMParser`** 와 DOM API (`querySelectorAll`, `textContent`, `outerHTML`, `getAttribute` 등)를 사용하여 프론트엔드에서 직접 HTML을 파싱하고 데이터를 추출합니다. **백엔드는 이 노드의 파싱 및 추출 과정에 관여하지 않습니다.**
-   **출력:** 추출된 데이터를 포함하는 JavaScript 객체 (`{ "rule_name": "extracted_value", ... }`)를 다음 노드로 전달합니다.

### 2. 프론트엔드 UI (노드 설정 패널)

#### 2.1. 추출 규칙 (Extraction Rules) 탭

이 탭에서는 HTML에서 데이터를 추출하기 위한 규칙을 관리합니다.

-   **규칙 목록:** 정의된 규칙들이 이름, 추출 유형, 선택자 요약과 함께 표시됩니다.
-   **규칙 추가/수정:**
    -   '+ 규칙 추가' 버튼을 누르거나 기존 규칙의 편집(✎) 버튼을 누르면 규칙 편집 폼이 목록 위에 나타납니다. (기존 규칙 목록은 계속 보입니다.)
    -   **규칙 이름:** 추출된 데이터의 키(key)로 사용될 고유한 이름 (필수).
    -   **추출 유형:**
        -   `텍스트`: 선택된 요소와 그 자손 요소들의 텍스트 내용만 추출합니다 (HTML 태그 제외).
        -   `HTML`: 선택된 요소 자체의 HTML 코드 전체(태그 포함)를 추출합니다.
        -   `속성`: 선택된 요소의 특정 HTML 속성 값을 추출합니다.
    -   **CSS 선택자:**
        -   데이터를 추출할 HTML 요소를 지정하는 표준 CSS 선택자 문자열입니다.
        -   **직접 입력:** 필드에 직접 CSS 선택자를 입력할 수 있습니다. (예: `div.content ul li a[target="_blank"]`)
        -   **DOM 선택 활용:** 'HTML 구조 탐색' 탭에서 요소를 선택하고 '이 요소 사용하기' 버튼을 누르면, 해당 요소까지의 경로가 레벨(Lv1, Lv2...) 형식으로 표시되고, 내부적으로 생성된 CSS 선택자 문자열이 사용됩니다. 이 경우 CSS 선택자 필드는 읽기 전용 경로 표시로 대체되며, 그 아래에 실제 사용될 선택자 문자열이 회색으로 표시됩니다.
    -   **속성 (추출 유형이 '속성'일 때):** 추출할 HTML 속성의 이름 (예: `href`, `src`, `data-id`).
    -   **다중 요소 선택:** 체크 시, CSS 선택자와 일치하는 **모든** 요소에서 데이터를 추출하여 **배열**로 반환합니다. 체크 해제 시, 일치하는 **첫 번째** 요소에서만 데이터를 추출하여 **단일 값**(문자열)으로 반환합니다.
    -   저장/취소 버튼으로 편집 내용을 반영하거나 취소합니다.
-   **규칙 삭제:** 규칙 목록에서 삭제(✕) 버튼을 눌러 해당 규칙을 제거합니다.

#### 2.2. HTML 구조 탐색 (HTML Structure) 탭

이 탭에서는 입력받은 HTML의 구조를 시각적으로 탐색하고 요소를 선택하여 추출 규칙 생성을 도울 수 있습니다.

-   **DOM 트리 뷰:** 입력된 HTML을 파싱하여 계층적인 트리 구조로 보여줍니다.
    -   노드를 클릭하여 펼치거나 접을 수 있습니다 (`toggleExpand`).
    -   요소를 클릭하면 해당 요소가 선택됩니다 (`handleElementSelect`).
-   **텍스트 검색:**
    -   입력 필드에 텍스트를 입력하고 검색(돋보기 아이콘) 버튼을 누르면, DOM 내 모든 요소의 `outerHTML`을 검사하여 입력된 텍스트를 포함하는 요소를 찾습니다.
    -   검색 결과가 있으면 개수와 현재 순번이 표시되며, 이전/다음(❮/❯) 버튼으로 일치하는 요소 간 이동이 가능합니다.
    -   검색 결과가 선택되면 해당 요소가 DOM 트리 뷰에서 강조 표시되고, 필요하면 상위 노드들이 자동으로 펼쳐집니다.
-   **선택된 요소:**
    -   DOM 트리 뷰에서 요소를 클릭하면 이 섹션에 정보가 표시됩니다.
    -   **경로:** 루트 요소부터 선택된 요소까지의 경로가 레벨(Lv1: 태그, Lv2: 태그...) 형식으로 표시됩니다.
    -   **CSS 선택자:** 해당 요소를 특정할 수 있도록 자동으로 생성된 CSS 선택자 문자열이 표시됩니다.
    -   **미리보기:** 선택된 요소의 HTML 코드 미리보기가 표시됩니다.
    -   **이 요소 사용하기:** 이 버튼을 클릭하면 현재 선택된 요소의 정보(경로 및 생성된 CSS 선택자)가 '추출 규칙' 탭의 새 규칙 편집 폼으로 전달됩니다.

### 3. 프론트엔드 실행 로직 (`core/HTMLParserNode.ts`)

`HTML Parser` 노드가 실행될 때의 내부 로직은 다음과 같습니다.

1.  **입력 처리:**
    -   이전 노드로부터 전달받은 입력(`input`)을 분석합니다.
    -   `getHtmlContentFromInput` 헬퍼 함수를 사용하여 다양한 입력 형태 (HTML 문자열, `Document` 객체, `.html` 또는 `.text` 필드를 가진 객체)로부터 실제 파싱할 HTML 콘텐츠(`htmlContent`)를 추출합니다.
    -   유효한 HTML 콘텐츠를 찾지 못하면 원본 입력을 그대로 다음 노드로 전달하고 실행을 종료합니다.
2.  **규칙 로딩:**
    -   `useNodeContentStore`를 통해 현재 노드에 설정된 `extractionRules` 배열을 가져옵니다.
    -   규칙이 하나도 정의되지 않은 경우, 추출된 `htmlContent` 문자열 자체를 결과로 반환합니다.
3.  **HTML 파싱 및 데이터 추출:**
    -   `extractFromHTML` 함수 내부에서 `DOMParser().parseFromString(htmlContent, 'text/html')`를 호출하여 브라우저 네이티브 파서로 HTML 문자열을 `Document` 객체로 변환합니다.
    -   각 `extractionRule`에 대해 반복합니다:
        -   `rule.selector`를 사용하여 `document.querySelectorAll()` 또는 `document.querySelector()` (내부적으로 `extractFromHTML`에서 처리)로 해당하는 요소를 찾습니다.
        -   `extractContent` 함수는 찾아진 요소(들)에 대해 `rule.target` (`text`, `html`, `attribute`)과 `rule.attribute_name`을 사용하여 `element.textContent`, `element.outerHTML`, `element.getAttribute()` 등으로 데이터를 추출합니다.
        -   `rule.multiple` 설정에 따라 결과가 단일 값(문자열) 또는 배열(문자열[])로 처리됩니다.
4.  **결과 객체 생성:**
    -   각 규칙의 이름(`rule.name`)을 키로, 추출된 데이터(단일 값 또는 배열)를 값으로 하는 JavaScript 객체(`result`)를 생성합니다.
5.  **출력 전달:**
    -   생성된 `result` 객체를 `this.context.storeOutput`으로 상태 저장소에 저장하고, `this.context.markNodeSuccess`로 성공 상태를 표시한 후, 다음 노드로 전달합니다.

### 4. 백엔드 상호작용 및 역할

-   **HTML Parser 노드:** 위에서 설명한 대로, 이 노드의 **모든 파싱 및 데이터 추출 로직은 프론트엔드(브라우저)**에서 이루어집니다. 백엔드 API를 호출하지 않습니다.
-   **Web Crawler 노드 (예시):** HTML Parser 노드의 일반적인 입력 소스인 Web Crawler 노드는 **백엔드**에서 실행됩니다. 주요 역할은 다음과 같습니다:
    -   주어진 URL의 웹 페이지에 접근합니다.
    -   필요한 경우, 동적 콘텐츠 로딩을 위해 특정 요소가 나타날 때까지 대기하거나 지정된 시간만큼 지연 실행합니다.
    -   최종적으로 **순수한 HTML 문자열**을 가져와 다음 노드(주로 HTML Parser)로 전달하는 것을 목표로 합니다. (백엔드에서 HTML을 파싱하거나 데이터를 추출하지 않습니다.)

### 5. 데이터 흐름 및 출력 형식

-   **입력:** 주로 HTML 문자열.
-   **처리:** 프론트엔드 DOM 파싱 및 규칙 기반 데이터 추출.
-   **출력:** 추출 규칙의 이름들을 키로 가지고, 각 규칙에 해당하는 추출된 데이터(문자열 또는 문자열 배열)를 값으로 가지는 **JavaScript 객체(Object)**.

```json
// 예시 출력 객체
{
  "page_title": "Example Product Page",
  "product_price": "$99.99",
  "image_urls": [
    "https://example.com/image1.jpg",
    "https://example.com/image2.png"
  ],
  "description_html": "<p>This is a <b>great</b> product.</p>"
}
```

이 객체는 다음 노드로 전달되어 추가 처리(예: `JSON Extractor` 노드에서 특정 값 추출, `Output` 노드에서 결과 표시 등)에 사용될 수 있습니다. 